__license__   = 'GPL v3'
__copyright__ = '2008-2011, Darko Miletic <darko.miletic at gmail.com>'
'''
mondediplo.com
'''

import urllib, os.path as p, re, datetime as dt
from calibre import strftime
from calibre.web.feeds.news import BasicNewsRecipe

class LeMondeDiplomatiqueDe(BasicNewsRecipe):
    title                  = 'LMD - Ausgabe vom '
    __author__             = 'Michael Kiometzis'
    description            = "Deutschsprachige Ausgabe der französischen Monatszeitung Le Monde Diplomatiqe für internationale Politik."
    publisher              = 'taz, die Tageszeitung'
    category               = 'Le Monde diplomatique, Politik, Analyse, Umwelt, Wirtschaft, Gesellschaft, Kultur, Hintergrundinformationen, Globalisierung'
    no_stylesheets         = False
    oldest_article         = 365
    delay                  = 1
    encoding               = 'utf-8'
    needs_subscription     = False
    masthead_url           = 'http://www.cinearte.cl/wp_content/uploads/2012/12/logo_mondediplo.jpg'
    publication_type       = 'newspaper'
    PREFIX                 = 'http://www.monde-diplomatique.de'
    use_embedded_content   = False
    language               = 'de'
    
    conversion_options = {
                          'comment'   : description
                        , 'tags'      : category
                        , 'publisher' : publisher
                        , 'language'  : language
                        }

    keep_only_tags    =[
                          dict(name='div', attrs={'id':'content'})
                        ]
    remove_tags = [
                      dict(name='h1'),
                      dict(name='span',attrs={'class':'cssbutton'}),
                      dict(name='img',attrs={'class':'printIcon'})
                  ]
#    remove_attributes = ['height','width','name','lang']
    
    extra_css = '@font-face{font-family:SZ Sans;font-stretch:normal;font-style:normal;font-weight:700;src:url(../fonts/SZSans-Bold.otf) format("opentype")}\
    body,div,h1,h2,h3,html,li,p,ul{font-size:100%;font-weight:400;margin:0;padding:0}\
    a{color:inherit;text-decoration:underline}\
    a:focus,a:hover{text-decoration:none}\
    ul{list-style-type:none}\
    .global{display:block;padding:3.75em 1.25em;position:static}\
    html{background:#fff;color:#333;font-family:georgia,times,serif;line-height:1.4;text-align:left!important}\
    b,strong{font-weight:700}em,i{font-style:italic}\
    .Titel,.Unterzeile,.Korrespondent{padding:3.75em 1.25em}\
    .Zwischentitel{font-family:SZ Sans,Neue Helvetica,Helvetica,sans-serif;font-size:1.5em;font-weight:700;line-height:1.1;margin:.83333em 0}\
    .Korrespondent{margin:1.25em 0;text-transform:uppercase}\
    .Brot p{margin:1.25em 0}\
    .Titel{display:block}\
    .Titel{font-family:SZ Sans,Neue Helvetica,Helvetica,sans-serif;font-size:2.25em;font-weight:700;line-height:1.1;margin-top:.13889em}\
    .Unterzeile{font-size:1.5em;margin-top:.10417em}\
    .c-infobox{margin:2.22222em 0 2.22222em 1.66667em}\
    .c-infobox__title{font-size:1.125em;margin-bottom:.13889em}\
    .c-image-text-module__title,\
    .c-infobox__title{font-family:SZ Sans,Neue Helvetica,Helvetica,sans-serif;font-weight:700}.c-image-text-module__title{font-size:1.5em;margin-top:.20833em}\
    .c-image-text-module__text{margin-bottom:1.25em}.c-image{margin:2.22222em 0}\
    .c-image__title{font-family:SZ Sans,Neue Helvetica,Helvetica,sans-serif;font-size:1.125em;font-weight:700}\
    .c-image__caption{font-size:.875em}\
    .c-departments__title{font-family:SZ Sans,Neue Helvetica,Helvetica,sans-serif;font-size:2em;font-weight:700}\
    .c-departments__subtitle{font-size:1.25em;margin-bottom:1.5em}\
    .c-departments__item{letter-spacing:1px;margin:1.25em 0;text-transform:uppercase}\
    .c-departments__item:last-child,\
    .c-nav{margin-bottom:2.5em}.c-nav__overview{float:left}.c-nav__overview--standalone{float:none}.c-nav__next{text-align:right}.c-pagina{font-weight:400;letter-spacing:1px;margin-bottom:1.875em;text-transform:uppercase}.c-teaser{margin:1.875em 0}.c-teaser__headline,.c-teaser__kicker{display:block}.c-teaser__kicker{font-weight:400}.c-teaser__headline{font-family:SZ Sans,Neue Helvetica,Helvetica,sans-serif;font-size:1.375em;font-weight:700;line-height:1.1;margin-bottom:.22727em}'
   
    datefile = p.expanduser('~') + "/.lmd.date"
    f = open( datefile )
    datestring = f.read()
    date = dt.datetime.strptime(datestring,'%d.%m.%Y')
    f.close()
    
    INDEX                  = PREFIX + date.strftime("/archiv-text?text=%Y-%m-%d")

    def parse_index(self):
        articles = []
        dom = self.index_to_soup(self.INDEX)
        self.title += self.datestring
        toc = dom.find('div',{'id':'content'}).ul
        for item in toc.findAll('li'):
            if item.a:
              feed_link = item.a['href']
              url   = self.PREFIX + feed_link
              title = item.a.strong.string
              item.a.extract()
              author = item.em.string if item.em else ''
              description = item.renderContents()
              articles.append({
                              'title'      :title
                             ,'url'        :url
                             ,'date'       :self.date.strftime("%m/%Y")
                             ,'description':description
                             ,'author'     :author
                            })
        return [(self.title, articles)]
    
    def preprocess_raw_html(self, string, soup):
        re_p=re.compile('<p')
        re_div=re.compile('<div id="content"')
        string = re_p.sub('\n<p',string)
        return re_div.sub('<div id="content" class="global"',string)

    def get_cover_url(self):
        return self.date.strftime("https://dl.taz.de/titel/%Y/lmd_%Y_%m_%d.120.jpg")

